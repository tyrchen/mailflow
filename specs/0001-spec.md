# Product Specification: Mailflow - Email Dispatching System

**Version:** 1.0
**Date:** 2025-10-31
**Status:** Draft

## 1. Executive Summary

Mailflow is an AWS-based email dispatching system that enables applications to receive and respond to emails through a centralized routing mechanism. The system receives emails via Amazon SES, routes them to application-specific SQS queues based on recipient addresses, and handles outbound responses through a unified queue.

## 2. System Overview

### 2.1 Core Components

- **Amazon SES (Simple Email Service)**: Email reception endpoint
- **Amazon S3**: Storage for email attachments and large email bodies
- **Amazon SQS**: Message queuing for both inbound and outbound email processing
- **AWS Lambda**: Serverless compute for email processing logic
- **Mailflow Router**: Lambda function that processes inbound emails and routes to appropriate queues
- **Mailflow Sender**: Lambda function (same as router) that processes outbound queue and sends emails

### 2.2 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         Inbound Flow                             │
└─────────────────────────────────────────────────────────────────┘

Internet Email → SES → S3 (raw email) → Lambda (Router) → SQS (mailflow-<app>)
                          ↓
                    S3 (attachments)

┌─────────────────────────────────────────────────────────────────┐
│                         Outbound Flow                            │
└─────────────────────────────────────────────────────────────────┘

App → SQS (mailflow-outbound) → Lambda (Sender) → SES → Internet Email
                                      ↓
                                S3 (attachments)
```

## 3. Functional Requirements

### 3.1 Inbound Email Processing

#### 3.1.1 Email Reception

- **FR-1.1**: System MUST receive emails sent to any address in configured domain(s) via SES
- **FR-1.2**: System MUST support multiple domains (e.g., acme.com, example.com)
- **FR-1.3**: System MUST handle emails up to 40 MB (SES limit with S3 storage)
- **FR-1.4**: System MUST preserve original email headers and metadata

#### 3.1.2 Email Parsing

- **FR-1.5**: System MUST extract the following from received emails:
  - Sender email address (From)
  - Recipient email address (To)
  - CC and BCC recipients
  - Subject line
  - Email body (plain text and HTML)
  - Attachments (name, content type, size, S3 location)
  - Message ID
  - Timestamp
  - Reply-To address (if present)
  - In-Reply-To and References headers (for threading)

- **FR-1.6**: System MUST support MIME multipart emails
- **FR-1.7**: System MUST handle various character encodings (UTF-8, ISO-8859-1, etc.)
- **FR-1.8**: System MUST extract inline images and treat them as attachments

#### 3.1.3 Recipient Routing

- **FR-1.9**: System MUST route emails based on recipient address pattern: `_<app-name>@<domain>`
- **FR-1.10**: App name MUST be extracted from the local part after underscore prefix
  - Example: `_app1@acme.com` → routes to `mailflow-app1`
  - Example: `_invoices@acme.com` → routes to `mailflow-invoices`

- **FR-1.11**: System MUST support configurable routing rules via configuration file or DynamoDB table
- **FR-1.12**: System MUST validate that target SQS queue exists before routing
- **FR-1.13**: System MUST handle multiple recipients in a single email:
  - If all recipients belong to same app, send one message to that queue
  - If recipients belong to different apps, send separate messages to each app's queue
  - If mixed (app addresses and non-app addresses), process only app addresses

#### 3.1.4 Attachment Handling

- **FR-1.14**: System MUST store attachments in S3 with the following structure:

  ```
  s3://mailflow-raw-emails/{message-id}/attachments/{attachment-filename}
  ```

- **FR-1.15**: System MUST generate pre-signed URLs for attachments with configurable expiration (default: 7 days)
- **FR-1.16**: System MUST support attachments up to 35 MB per file
- **FR-1.17**: System MUST validate attachment file types against configurable allow/block lists
- **FR-1.18**: System MUST scan attachments for malware using AWS GuardDuty or third-party integration
- **FR-1.19**: System MUST preserve original filename and content type metadata

#### 3.1.5 Message Format to SQS

- **FR-1.20**: System MUST send messages to app queues in the following JSON format:

```json
{
  "version": "1.0",
  "messageId": "unique-message-id",
  "timestamp": "2025-10-31T12:34:56Z",
  "source": "mailflow",
  "email": {
    "messageId": "original-email-message-id",
    "from": {
      "address": "sender@example.com",
      "name": "Sender Name"
    },
    "to": [
      {
        "address": "_app1@acme.com",
        "name": "App1"
      }
    ],
    "cc": [],
    "replyTo": {
      "address": "reply@example.com",
      "name": "Reply Address"
    },
    "subject": "Email Subject",
    "body": {
      "text": "Plain text body",
      "html": "<html>HTML body</html>"
    },
    "attachments": [
      {
        "filename": "document.pdf",
        "contentType": "application/pdf",
        "size": 123456,
        "s3Bucket": "mailflow-raw-emails",
        "s3Key": "message-id/attachments/document.pdf",
        "presignedUrl": "https://...",
        "presignedUrlExpiration": "2025-11-07T12:34:56Z"
      }
    ],
    "headers": {
      "in-reply-to": "previous-message-id",
      "references": "message-id-1 message-id-2"
    },
    "receivedAt": "2025-10-31T12:34:56Z"
  },
  "metadata": {
    "routingKey": "app1",
    "domain": "acme.com",
    "spamScore": 0.1,
    "dkimVerified": true,
    "spfVerified": true
  }
}
```

### 3.2 Outbound Email Processing

#### 3.2.1 Queue Monitoring

- **FR-2.1**: System MUST poll `mailflow-outbound` SQS queue continuously
- **FR-2.2**: System MUST use long polling (20 seconds) to reduce costs
- **FR-2.3**: System MUST process messages in batches (up to 10 messages)

#### 3.2.2 Message Format from Apps

- **FR-2.4**: System MUST accept messages in the following JSON format:

```json
{
  "version": "1.0",
  "correlationId": "app-specific-id",
  "timestamp": "2025-10-31T12:34:56Z",
  "source": "app1",
  "email": {
    "from": {
      "address": "_app1@acme.com",
      "name": "App1 System"
    },
    "to": [
      {
        "address": "recipient@example.com",
        "name": "Recipient Name"
      }
    ],
    "cc": [],
    "bcc": [],
    "replyTo": {
      "address": "_app1@acme.com",
      "name": "App1 Support"
    },
    "subject": "Response Subject",
    "body": {
      "text": "Plain text response",
      "html": "<html>HTML response</html>"
    },
    "attachments": [
      {
        "filename": "response.pdf",
        "contentType": "application/pdf",
        "s3Bucket": "app1-attachments",
        "s3Key": "responses/response.pdf"
      }
    ],
    "headers": {
      "in-reply-to": "original-message-id",
      "references": "message-id-chain"
    }
  },
  "options": {
    "priority": "normal",
    "scheduledSendTime": null,
    "trackOpens": false,
    "trackClicks": false
  }
}
```

#### 3.2.3 Email Composition

- **FR-2.5**: System MUST compose valid MIME emails from JSON payload
- **FR-2.6**: System MUST support both plain text and HTML email bodies
- **FR-2.7**: System MUST create multipart/alternative for emails with both text and HTML
- **FR-2.8**: System MUST retrieve attachments from specified S3 locations
- **FR-2.9**: System MUST validate attachment sizes (total < 10 MB for SES)
- **FR-2.10**: System MUST set appropriate email headers (Message-ID, Date, MIME-Version, etc.)
- **FR-2.11**: System MUST preserve threading headers (In-Reply-To, References)

#### 3.2.4 Email Sending

- **FR-2.12**: System MUST send emails via SES SendRawEmail API
- **FR-2.13**: System MUST validate sender addresses are verified in SES
- **FR-2.14**: System MUST handle SES sending limits (14 emails/second default)
- **FR-2.15**: System MUST respect SES daily sending quota
- **FR-2.16**: System MUST implement exponential backoff for rate limiting
- **FR-2.17**: System MUST support delayed sending if scheduledSendTime is specified

#### 3.2.5 Delivery Tracking

- **FR-2.18**: System MUST log all sent emails with:
  - Correlation ID
  - SES Message ID
  - Timestamp
  - Recipients
  - Status (sent, failed, bounced)

- **FR-2.19**: System MUST handle SES bounce and complaint notifications
- **FR-2.20**: System MUST store delivery notifications in DynamoDB or CloudWatch Logs

## 4. Non-Functional Requirements

### 4.1 Performance

- **NFR-1.1**: System MUST process inbound emails within 5 seconds (95th percentile)
- **NFR-1.2**: System MUST process outbound emails within 10 seconds (95th percentile)
- **NFR-1.3**: System MUST support at least 100 emails/minute inbound processing
- **NFR-1.4**: System MUST support at least 50 emails/minute outbound processing
- **NFR-1.5**: Lambda functions MUST have timeout ≤ 60 seconds

### 4.2 Reliability

- **NFR-2.1**: System MUST achieve 99.9% uptime
- **NFR-2.2**: System MUST not lose emails (at-least-once delivery guarantee)
- **NFR-2.3**: System MUST use SQS message visibility timeout to prevent duplicate processing
- **NFR-2.4**: System MUST implement idempotency for email sending (deduplicate within 24 hours)
- **NFR-2.5**: System MUST retry failed operations with exponential backoff (max 5 retries)
- **NFR-2.6**: System MUST move failed messages to DLQ after max retries

### 4.3 Security

- **NFR-3.1**: System MUST validate SPF, DKIM, and DMARC for inbound emails
- **NFR-3.2**: System MUST reject emails from untrusted sources based on configurable rules
- **NFR-3.3**: System MUST encrypt data at rest in S3 using AWS KMS
- **NFR-3.4**: System MUST encrypt data in transit using TLS 1.2+
- **NFR-3.5**: System MUST implement least-privilege IAM roles for Lambda functions
- **NFR-3.6**: System MUST sanitize email content to prevent XSS attacks
- **NFR-3.7**: System MUST implement rate limiting per sender/recipient
- **NFR-3.8**: System MUST support email content filtering (spam, malware)
- **NFR-3.9**: System MUST redact sensitive data in logs (email addresses, content)
- **NFR-3.10**: System MUST rotate pre-signed URLs and access tokens regularly

### 4.4 Scalability

- **NFR-4.1**: System MUST auto-scale Lambda functions based on queue depth
- **NFR-4.2**: System MUST handle burst traffic up to 1000 emails/minute
- **NFR-4.3**: System MUST support adding new apps without code changes
- **NFR-4.4**: System MUST support multiple AWS regions for disaster recovery

### 4.5 Observability

- **NFR-5.1**: System MUST log all operations to CloudWatch Logs
- **NFR-5.2**: System MUST emit metrics for:
  - Email processing time
  - Queue depth
  - Error rates
  - Attachment sizes
  - Routing decisions

- **NFR-5.3**: System MUST provide dashboards for monitoring system health
- **NFR-5.4**: System MUST alert on:
  - Processing failures (> 5% error rate)
  - Queue depth exceeding threshold
  - DLQ message count > 0
  - SES bounce rate > 5%
  - Lambda errors or timeouts

- **NFR-5.5**: System MUST implement distributed tracing (X-Ray)
- **NFR-5.6**: System MUST retain logs for at least 30 days

### 4.6 Maintainability

- **NFR-6.1**: System MUST use Infrastructure as Code (CloudFormation/Terraform)
- **NFR-6.2**: System MUST have comprehensive unit tests (>80% coverage)
- **NFR-6.3**: System MUST have integration tests for critical paths
- **NFR-6.4**: System MUST document all configuration parameters
- **NFR-6.5**: System MUST support blue-green deployments

## 5. Edge Cases and Error Handling

### 5.1 Inbound Processing Edge Cases

#### 5.1.1 Invalid or Malformed Emails

- **EC-1.1**: Emails with invalid MIME structure → Log error, send to DLQ, notify admin
- **EC-1.2**: Emails with unsupported character encoding → Attempt best-effort decoding, log warning
- **EC-1.3**: Emails exceeding size limit (40 MB) → SES rejects (handled at SES level)
- **EC-1.4**: Emails with corrupted attachments → Log error, include error in message payload

#### 5.1.2 Routing Edge Cases

- **EC-1.5**: Recipient doesn't match app pattern (no underscore prefix) → Send to `mailflow-default` queue or reject
- **EC-1.6**: App name not in routing configuration → Send to `mailflow-unknown` queue or reject
- **EC-1.7**: Target SQS queue doesn't exist → Log error, send to DLQ, alert admin
- **EC-1.8**: Email sent to multiple apps → Create separate messages for each app queue
- **EC-1.9**: Email with no recipients → Log error, send to DLQ
- **EC-1.10**: Email with only BCC recipients → Process BCC as normal recipients

#### 5.1.3 Attachment Edge Cases

- **EC-1.11**: Attachment filename contains special characters → Sanitize filename, preserve in metadata
- **EC-1.12**: Multiple attachments with same filename → Append unique suffix (e.g., document(1).pdf)
- **EC-1.13**: Attachment fails malware scan → Remove attachment, add warning to message
- **EC-1.14**: Attachment type in block list → Remove attachment, log warning
- **EC-1.15**: S3 upload fails → Retry up to 3 times, then fail entire message to DLQ

#### 5.1.4 S3 and Storage Edge Cases

- **EC-1.16**: S3 bucket full or quota exceeded → Alert admin, reject new emails
- **EC-1.17**: S3 bucket not accessible → Fail processing, send to DLQ, alert admin
- **EC-1.18**: Pre-signed URL generation fails → Log error, omit presignedUrl field

### 5.2 Outbound Processing Edge Cases

#### 5.2.1 Message Validation Edge Cases

- **EC-2.1**: Missing required fields (from, to, subject) → Reject message to DLQ with validation error
- **EC-2.2**: Invalid email address format → Reject message to DLQ
- **EC-2.3**: Sender not verified in SES → Reject message to DLQ, alert admin
- **EC-2.4**: Total attachment size exceeds 10 MB → Reject message with error
- **EC-2.5**: Attachment not found in S3 → Log error, send email without attachment, notify app

#### 5.2.2 SES Sending Edge Cases

- **EC-2.6**: SES rate limit exceeded → Implement exponential backoff, retry up to 5 times
- **EC-2.7**: SES daily quota exceeded → Queue messages for next day, alert admin
- **EC-2.8**: SES returns permanent failure (invalid recipient) → Move to DLQ, log error
- **EC-2.9**: SES returns temporary failure → Retry with exponential backoff
- **EC-2.10**: Network timeout → Retry up to 3 times with increasing timeout

#### 5.2.3 Email Threading Edge Cases

- **EC-2.11**: Missing In-Reply-To header → Send as new thread (not a reply)
- **EC-2.12**: Invalid References header → Log warning, sanitize or omit header

#### 5.2.4 Scheduled Sending Edge Cases

- **EC-2.13**: scheduledSendTime in past → Send immediately
- **EC-2.14**: scheduledSendTime > 14 days in future → Reject message (SES visibility timeout limit)

### 5.3 System-Level Edge Cases

#### 5.3.1 Queue Management

- **EC-3.1**: SQS queue full → Unlikely (SQS is unlimited), but monitor queue depth
- **EC-3.2**: Message larger than 256 KB (SQS limit) → Store in S3, send pointer message
- **EC-3.3**: Visibility timeout expires → Message reprocessed (ensure idempotency)
- **EC-3.4**: DLQ accumulates messages → Alert admin, provide manual reprocessing tool

#### 5.3.2 Lambda Execution

- **EC-3.5**: Lambda cold start delay → Use provisioned concurrency for critical functions
- **EC-3.6**: Lambda timeout → Implement checkpoint/resume pattern for long operations
- **EC-3.7**: Lambda out of memory → Increase memory allocation, optimize code
- **EC-3.8**: Concurrent Lambda execution limit → Request limit increase, implement throttling

#### 5.3.3 Data Consistency

- **EC-3.9**: Duplicate message processing → Use message deduplication ID (SQS FIFO) or idempotency key
- **EC-3.10**: Race condition (same email to multiple queues) → Acceptable, apps handle duplicates
- **EC-3.11**: S3 eventual consistency → Verify object exists before generating presigned URL

#### 5.3.4 Configuration and Deployment

- **EC-3.12**: Invalid configuration → Validate on startup, fail fast with clear error
- **EC-3.13**: Deployment failure → Rollback automatically, alert admin
- **EC-3.14**: New app added without queue → Validate queue existence, create if missing (if auto-provisioning enabled)

### 5.4 Security Edge Cases

#### 5.4.1 Email Spoofing and Abuse

- **EC-4.1**: Spoofed sender address → Validate SPF/DKIM, reject if failed
- **EC-4.2**: Spam flood attack → Implement rate limiting per sender IP/domain
- **EC-4.3**: Malicious attachment → Quarantine, send email without attachment
- **EC-4.4**: Email bomb (extremely large email) → SES rejects at 40 MB limit
- **EC-4.5**: Phishing attempt → Content filtering, warn recipient if suspicious

#### 5.4.2 Access Control

- **EC-4.6**: Unauthorized app sends to outbound queue → Validate source via SQS permissions
- **EC-4.7**: Presigned URL shared publicly → URL expires after configured time
- **EC-4.8**: S3 bucket policy misconfigured → Validate during deployment

## 6. Data Flow Diagrams

### 6.1 Inbound Email Flow

```
1. Email arrives at SES
   ↓
2. SES saves raw email to S3 (s3://mailflow-raw-emails/{message-id})
   ↓
3. SES triggers Lambda (Mailflow Router) via SNS or direct invocation
   ↓
4. Lambda downloads email from S3
   ↓
5. Lambda parses email:
   - Extract headers, body, attachments
   - Validate SPF/DKIM
   - Scan for malware
   ↓
6. Lambda saves attachments to S3 (s3://mailflow-raw-emails/{message-id}/attachments/*)
   ↓
7. Lambda generates presigned URLs for attachments
   ↓
8. Lambda determines routing:
   - Extract app name from recipient (_<app>@<domain>)
   - Lookup target queue (mailflow-<app>)
   - Validate queue exists
   ↓
9. Lambda constructs JSON message
   ↓
10. Lambda sends message to target SQS queue(s)
    ↓
11. Lambda deletes raw email from S3 (optional, based on retention policy)
    ↓
12. Lambda logs success/failure to CloudWatch
```

### 6.2 Outbound Email Flow

```
1. App sends JSON message to mailflow-outbound SQS queue
   ↓
2. Lambda (Mailflow Sender) polls queue and receives message
   ↓
3. Lambda validates message format and required fields
   ↓
4. Lambda checks idempotency (has this correlationId been processed?)
   - If yes: Skip processing, delete from queue
   - If no: Continue
   ↓
5. Lambda retrieves attachments from S3 (if any)
   ↓
6. Lambda validates total size < 10 MB
   ↓
7. Lambda composes MIME email:
   - Set headers (From, To, Subject, Date, Message-ID, etc.)
   - Create multipart structure
   - Encode attachments
   ↓
8. Lambda checks SES sending quota
   - If exceeded: Return message to queue with delay, alert admin
   - If ok: Continue
   ↓
9. Lambda sends email via SES SendRawEmail
   ↓
10. Lambda records send operation:
    - Store correlationId in DynamoDB/cache (for idempotency)
    - Log to CloudWatch
    - Emit metrics
    ↓
11. Lambda deletes message from queue
    ↓
12. SES processes delivery, bounce, complaint notifications (separate flow)
```

### 6.3 Error Handling Flow

```
Error occurs in Lambda
   ↓
Is error retriable?
   ↓
   ├─ Yes ─→ Return error (SQS will retry based on visibility timeout)
   │         ↓
   │    Retry count < max retries? ─→ Yes ─→ Lambda processes again
   │         ↓ No
   │    Move to DLQ
   │         ↓
   │    Trigger DLQ alarm
   │         ↓
   │    Admin investigates and reprocesses manually
   │
   └─ No ──→ Log error, send to DLQ immediately
```

## 7. Configuration

### 7.1 Router Configuration

Configuration stored in DynamoDB table `mailflow-config` or JSON file in S3:

```json
{
  "version": "1.0",
  "domains": ["acme.com", "example.com"],
  "routing": {
    "app1": {
      "queueUrl": "https://sqs.us-east-1.amazonaws.com/123456789/mailflow-app1",
      "enabled": true,
      "aliases": ["application1", "app-one"]
    },
    "invoices": {
      "queueUrl": "https://sqs.us-east-1.amazonaws.com/123456789/mailflow-invoices",
      "enabled": true
    }
  },
  "defaultQueue": "https://sqs.us-east-1.amazonaws.com/123456789/mailflow-default",
  "unknownQueue": "https://sqs.us-east-1.amazonaws.com/123456789/mailflow-unknown",
  "attachments": {
    "bucket": "mailflow-raw-emails",
    "presignedUrlExpiration": 604800,
    "maxSize": 36700160,
    "allowedTypes": ["application/pdf", "image/*", "text/*"],
    "blockedTypes": ["application/x-executable", "application/x-msdownload"],
    "scanForMalware": true
  },
  "security": {
    "requireSpf": false,
    "requireDkim": false,
    "requireDmarc": false,
    "maxEmailsPerSenderPerHour": 100
  },
  "retention": {
    "rawEmails": 7,
    "attachments": 30,
    "logs": 30
  }
}
```

### 7.2 Sender Configuration

```json
{
  "version": "1.0",
  "outboundQueue": "https://sqs.us-east-1.amazonaws.com/123456789/mailflow-outbound",
  "ses": {
    "region": "us-east-1",
    "configurationSet": "mailflow-tracking",
    "maxSendRate": 14,
    "maxAttachmentSize": 10485760
  },
  "idempotency": {
    "enabled": true,
    "tableName": "mailflow-idempotency",
    "ttl": 86400
  },
  "retry": {
    "maxRetries": 5,
    "baseDelay": 1000,
    "maxDelay": 300000
  }
}
```

## 8. API and Message Schemas

### 8.1 Inbound Message Schema (to app queues)

See FR-1.20 above for complete schema.

### 8.2 Outbound Message Schema (from apps)

See FR-2.4 above for complete schema.

### 8.3 DLQ Message Schema

```json
{
  "originalMessage": { /* original message */ },
  "error": {
    "code": "ROUTING_ERROR",
    "message": "Target queue mailflow-app99 does not exist",
    "timestamp": "2025-10-31T12:34:56Z",
    "stackTrace": "..."
  },
  "retryCount": 5,
  "firstAttempt": "2025-10-31T12:30:00Z",
  "lastAttempt": "2025-10-31T12:34:56Z"
}
```

## 9. Monitoring and Alerts

### 9.1 CloudWatch Metrics

- `InboundEmailsReceived` (Count)
- `InboundEmailsProcessed` (Count)
- `InboundProcessingTime` (Milliseconds)
- `RoutingDecisions` (Count, by app)
- `AttachmentsProcessed` (Count)
- `AttachmentSizes` (Bytes)
- `OutboundEmailsSent` (Count)
- `OutboundProcessingTime` (Milliseconds)
- `SESErrors` (Count, by error type)
- `DLQMessages` (Count)
- `QueueDepth` (Count, by queue)

### 9.2 Alarms

- High error rate (> 5% failures in 5 minutes)
- DLQ has messages (> 0 messages)
- Queue depth exceeds threshold (> 1000 messages for 10 minutes)
- Lambda errors or timeouts (> 10 in 5 minutes)
- SES bounce rate > 5%
- SES quota utilization > 80%
- Attachment malware detected (> 0)

## 10. Testing Strategy

### 10.1 Unit Tests

- Email parsing logic
- Routing logic
- MIME composition
- Validation functions
- Error handling

### 10.2 Integration Tests

- End-to-end inbound flow (SES → S3 → Lambda → SQS)
- End-to-end outbound flow (SQS → Lambda → SES)
- S3 attachment storage and retrieval
- SQS message processing
- DLQ handling

### 10.3 Load Tests

- 100 emails/minute sustained
- 1000 emails/minute burst
- Large attachments (35 MB)
- Concurrent processing

### 10.4 Security Tests

- SPF/DKIM validation
- Malware scanning
- XSS prevention in email content
- Rate limiting
- Access control

## 11. Deployment

### 11.1 Infrastructure Components

- **SES Receipt Rule Set**: Configure domain and rule actions
- **S3 Buckets**:
  - `mailflow-raw-emails` (7-day lifecycle policy)
- **SQS Queues**:
  - `mailflow-<app>` (one per app, configurable visibility timeout)
  - `mailflow-outbound`
  - `mailflow-dlq`
- **Lambda Functions**:
  - `mailflow` (256 MB memory, 60s timeout): Router and Sender
- **DynamoDB Tables**:
  - `mailflow-config` (routing configuration)
  - `mailflow-idempotency` (TTL enabled)
- **IAM Roles**: Least-privilege roles for each Lambda
- **CloudWatch Log Groups**: One per Lambda
- **SNS Topics**: For SES notifications and alarms

### 11.2 Deployment Steps

1. Deploy infrastructure (CloudFormation/Terraform)
2. Verify SES domain and sender addresses
3. Configure SES receipt rule set
4. Deploy Lambda functions
5. Populate routing configuration
6. Run smoke tests
7. Enable monitoring and alarms
8. Gradually increase traffic (canary deployment)

## 12. Disaster Recovery

### 12.1 Backup Strategy

- S3 buckets: Cross-region replication
- DynamoDB tables: Point-in-time recovery enabled
- Configuration: Version controlled in Git

### 12.2 Recovery Procedures

- Lambda failure: Automatic retry via SQS
- Region failure: Failover to secondary region (manual or automatic)
- Data loss: Restore from S3 cross-region replica
- Configuration corruption: Restore from Git + redeploy

## 13. Future Enhancements

- **Priority queues**: High/normal/low priority routing
- **Email templates**: Support for templated responses
- **Webhooks**: Real-time delivery notifications to apps
- **Email analytics**: Open/click tracking, engagement metrics
- **Multi-tenancy**: Support for multiple organizations
- **Advanced filtering**: Content-based routing rules
- **Scheduled sending**: Delay email delivery to specific time
- **Email campaigns**: Bulk sending with throttling
- **Compliance**: GDPR, data retention policies
- **A/B testing**: Send variations to different recipients

## 14. Success Metrics

- Email processing latency (p50, p95, p99)
- Email delivery rate (> 95%)
- System uptime (> 99.9%)
- Error rate (< 1%)
- Cost per email processed
- Time to add new app (< 5 minutes)

## 15. Assumptions and Dependencies

### 15.1 Assumptions

- Apps are responsible for polling their inbound queues
- Apps handle message deduplication (at-least-once delivery)
- SES domain is verified and has good sender reputation
- AWS account has sufficient SES sending quota
- Apps store their response attachments in S3

### 15.2 Dependencies

- AWS SES (email reception and sending)
- AWS S3 (attachment storage)
- AWS SQS (message queuing)
- AWS Lambda (compute)
- AWS DynamoDB (configuration and idempotency)
- AWS CloudWatch (monitoring and logging)

## 16. Glossary

- **App**: Application that receives and sends emails via Mailflow
- **Routing Key**: The app name extracted from email recipient (e.g., "app1" from "<_app1@acme.com>")
- **Correlation ID**: Unique identifier for tracking email threads across inbound/outbound
- **Message ID**: Unique identifier for each email (RFC 5322)
- **Presigned URL**: Temporary S3 URL with embedded credentials
- **DLQ**: Dead Letter Queue for failed messages
- **MIME**: Multipurpose Internet Mail Extensions
- **SPF/DKIM/DMARC**: Email authentication protocols

## 17. Open Questions

1. Should the system support email forwarding (relay emails to external addresses)?
2. Should apps be able to dynamically register/unregister via API?
3. What is the required retention period for raw emails and attachments?
4. Should the system support encryption for sensitive emails (PGP/S/MIME)?
5. Should there be a UI for monitoring and managing the system?
6. What SLA should be committed to apps (processing time, uptime)?
7. Should the system support email size limits per app?
8. How should email threading be handled for complex conversations?

---

**Document Approval**

| Role             | Name | Date | Signature |
| ---------------- | ---- | ---- | --------- |
| Product Manager  |      |      |           |
| Engineering Lead |      |      |           |
| Security Lead    |      |      |           |
| DevOps Lead      |      |      |           |
